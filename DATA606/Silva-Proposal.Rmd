---
title: "DATA 606 Data Project Proposal"
author: "Mike Silva"
date: "October 3, 2018"
output:
  html_document:
    theme: yeti
    highlight: tango
    toc: true
    toc_depth: 4
    toc_float: true
---

## Research Question

In a [2017 study done by Pew](http://www.pewresearch.org/fact-tank/2018/03/07/women-in-majority-male-workplaces-report-higher-rates-of-gender-discrimination/) found that women in majority-male wokplaces are more likely to say their gender has made it harder for them to get ahead at work.  

Does this trend hold at the macro level?  Otherwise put does the level of concentration within an occupation predict the differential in income earned between men and women? 

The response variable will be the differential.  I think I will use a ratio of female to male earnings.  In any case it will be numeric.

The explanatory variable will be the concentration level.  This will also be numeric.  I will use the occupation as a control variable.  It will be categorical.  I may also want to use a geographic variable which would also be categorical.

## Data Source

U.S. Census Bureau; American Community Survey, 2012-2016, Detailed Tables; generated by Mike Silva; using Census Bureau API; (9 October 2018)

## About the Data

The American Communtiy Survey (ACS) is the Census Bureau's replacement to the long form and collects information on the population, housing and workforce.

### Data Collection

Each year the U.S. Census Bureau contacts over 3.5 million households to participate in the ACS.  It is collected through mail, internet, telephone and in-person interviews.  Households are randomly selected and required by law to respond to all questions as accurately as possible.  The survey data is then weighted and estimates are produced.

The tables that will be used in this study are the latest 5 year estimates which incorporates the responses from 2012-2016.  I will be analyzing all county level estimates.  This level of geography is being chosen because the estimates will be more reliable than the city level data (due to number of survey responses in the estimates) while giving more observations than the state or metro levels.  The estimates are based on observational data.

### Data Acquisition

In order to pull the data I will be using the ACS R package.  I have previously [registered for an API key](https://api.census.gov/), and have use the *api.key.install()* command to save it to my environment.  I will pull the data via the API and save it locally to save time in the future.

```{r get_acs_data, message=FALSE}
library(censusapi)
library(dplyr)
library(tidyr)
library(stringr)

# C24010 SEX BY OCCUPATION FOR THE CIVILIAN EMPLOYED POPULATION 16 YEARS AND OVER
file_name <- "data/C24010_2016_5_est.csv"
if(!file.exists(file_name)){
  geos <- acs::geo.make(county = "*", state = "*")
  acs <- acs::acs.fetch(2016, geography = geos, table.number = "C24010", col.names = "pretty")
  acs_df_C24010 <- data.frame(acs::estimate(acs))
  write.csv(acs_df_C24010, file = file_name)
} else {
  acs_df_C24010 <- read.csv(file_name)
}

# B24022 SEX BY OCCUPATION AND MEDIAN EARNINGS IN THE PAST 12 MONTHS (IN 2016 INFLATION-ADJUSTED DOLLARS) FOR THE FULL-TIME, YEAR-ROUND CIVILIAN EMPLOYED POPULATION 16 YEARS AND OVER
file_name <- "data/B24022_2016_5_est.csv"
if(!file.exists(file_name)){
  geos <- acs::geo.make(county = "*", state = "*")
  acs <- acs::acs.fetch(2016, geography = geos, table.number = "B24022", col.names = "pretty")
  acs_df_B24022 <- data.frame(acs::estimate(acs))
  write.csv(acs_df_B24022, file = file_name)
} else {
  acs_df_B24022 <- read.csv(file_name)
}
```

The following function will be used to clean up the occupations.

```{r get_occupation}
get_occupation <- function(string){
  string <- str_remove(string, "SEX.BY.OCCUPATION.FOR.THE.CIVILIAN.EMPLOYED.POPULATION.16.YEARS.AND.OVER..")
  string <- str_remove(string, "B24022..Sex.by.Occupation.and.Median.Earnings.in.the.Past.12.Months..in.2015.Inflation.Adjusted.Dollars..for.the.Full.Time..Year.Round.Civilian.Employed.Population.16.Years.and.Over")
  string <- str_remove(string, "Female")
  string <- str_remove(string, "Male")
  string <- str_replace_all(string, "[.]", " ")
  string <- str_replace_all(string, "  ", " ")
  string <- trimws(string)
  # Simplify occupations - Select everything after the last capital letter started sequence
  search_for <- str_extract(string, "[A-Z][[:alpha:] ]+[A-Z]")
  replace_with <- str_sub(search_for, start=-1)
  string <- str_replace_all(string, search_for, replace_with)
  string
}
```

Now we will build a tidy dataset for analysis by reading in the two datasets, cleaning the occupational groups, and merging the two together.  The Census Bureau uses -666666666 for NAs in the earnings table (B24022).

```{r build_tidy_data}
# Wrangle the two ACS tables
acs_df_C24010 <- acs_df_C24010 %>%
  rename(County = X) %>%
  gather(key = Header, value = Workers, -County) %>%
  mutate(Occupation = get_occupation(Header),
         Gender = ifelse(grepl("Female", Header), "Female", ifelse(grepl("Male", Header), "Male", "Total"))) %>% 
  filter(Gender != "Total") %>%
  select(-Header) %>%
  drop_na()

acs_df_B24022 <- acs_df_B24022 %>%
  rename(County = X) %>%
  gather(key = Header, value = "Earnings", -County) %>%
  filter(Earnings > 0) %>%
  mutate(Occupation = get_occupation(Header),
         Gender = ifelse(grepl("Female", Header), "Female", ifelse(grepl("Male", Header), "Male", "Total"))) %>%
  filter(Gender != "Total") %>%
  select(-Header)

acs_df <- merge(acs_df_C24010, acs_df_B24022)

# Add in the occupation concentrations
acs_df <- acs_df %>%
  select(Occupation, County, Workers) %>%
  group_by(Occupation, County) %>%
  summarise(Total = sum(Workers)) %>% 
  merge(acs_df) %>%
  mutate(Concentration = Workers / Total) %>%
  select(-Total)

# Add in the female to male earnings ratio
acs_df <- acs_df %>%
  filter(Gender == "Male") %>%
  select(County, Occupation, Earnings) %>%
  rename(Male_Earnings = Earnings) %>%
  merge(acs_df) %>%
  filter(Gender == "Female") %>%
  mutate(Ratio = Earnings / Male_Earnings)
```

### Cases

There are `r nrow(acs_df)` observations in the dataset.  Each observation is the ratio of median earnings by occupation at the county level  The universe is the civilian employed population 16 years and over.  The occupational groups are based on the 2010 Standard Occupational Classification (SOC) definitions.

## Relevant Summary Statistics 

### Occupation Groups

There are `r length(unique(acs_df$Occupation))` occupations.  The following table summarizes the number of records by occupation:

##### Table 1. Count of Records by Occupation
```{r, echo=FALSE}
library(kableExtra)
acs_df %>%
  select(Occupation) %>%
  group_by(Occupation) %>%
  summarise(Records = n()) %>%
  ungroup() %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```

### Female Worker Concentration

##### Figure 1. Female Worker Concentration Histogram
```{r, echo=FALSE}
library(ggplot2)
ggplot(acs_df, aes(Concentration)) + geom_histogram(bins = 60)
```

The female concentration seems to be multi-modal.  I imagine there will be occupation groups that have higher concentration rates than others.

##### Table 2. Average Concentration Rate by Occupation
```{r, echo=FALSE}
acs_df %>%
  group_by(Occupation) %>%
  summarise(Concentration = mean(Concentration)) %>%
  ungroup() %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```

### Female Earning Ratio

Before looking at the dependent variable I want to look at the underlying earnings data.

##### Figure 2. Female Earnings Histogram
```{r, echo=FALSE}
ggplot(acs_df, aes(Earnings)) + geom_histogram(bins = 60)
```

The distribution is long-tailed.  Now to look at the independant variable.

##### Figure 3. Earnings Ratio Histogram
```{r, echo=FALSE}
ggplot(acs_df, aes(Ratio)) + geom_histogram(bins = 60)
```

The ratio seems to be long tailed too.  Most of the observations have a ratio less than one.

##### Table 3. ACS Summary Statistics for Numeric Variables
```{r acs_numeric_summary, echo=FALSE}
acs_df %>%
  select(Ratio, Concentration, Earnings) %>%
  summarise_all(funs(min=min, median=median, mean = mean, max=max)) %>%
  gather(stat, val) %>%
  separate(stat, into = c("Variable", "stat"), "_") %>%
  spread(stat, val) %>%
  select(Variable, min, mean, median, max) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```
